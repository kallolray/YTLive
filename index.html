<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>YT Live</title>
    <style>
        button:focus {
            outline: 8px ridge rgb(170 50 220 / 0.6);
            border-radius: 2rem;
        }
        .selected{background-color: lightgoldenrodyellow;}
        button {font-size: inherit;}
        #divStreams{
            display: flex; flex-wrap: wrap; width: 99vw; gap:1rem; font-size: medium; 
            div{height: 4rem; overflow-y: hidden;}
        }
        #divChannles{
            display: flex;flex-flow: row;width:fit-content;gap:2rem; margin-bottom: 15px;
        }
    </style>
    <script async src="https://www.youtube.com/iframe_api"></script>
</head>
<body style="font-size: xx-large;">
    <div id="player">Loading .....</div>
    <div id="divSelection" style="position:fixed; top: 10; display: none;">
        <div id="divChannles">
            <button data-yt="abpanandatv" data-type="C">ABP Ananda</button>
            <button data-yt="Zee24Ghanta" data-type="C">Zee 24 Ghanta</button>
            <button data-yt="republicbangla" data-type="C">Republic Bangla</button>
            <button data-yt="NDTV" data-type="C">NDTV</button>
            <button data-yt="RepublicWorld" data-type="C">Republic World</button>
            <button data-yt="TimesNow" data-type="C">Times Now</button>
        </div>
        <div id="divWaitForData" style="display:none">Getting Data - Please wait</div>
        <div id="divStreams" data-count="0"></div>
    </div>
    <script>
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: window.innerHeight,
                width: window.innerWidth,
                playerVars: {
                    'playsinline': 0
                },
                events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
                }
            });
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            player.mute();
            showSelectionDiv();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED || event.data == YT.PlayerState.PAUSED) {
                showSelectionDiv();
            }
        }
    </script>
    <script>
        function showSelectionDiv(){
            document.querySelector('#player').style.display = 'none';
            divSelection.style.display = 'block';
            if(divStreams.dataset.count > 0)
                (divStreams.querySelector('.selected')??divStreams.firstElementChild).focus();
            else
                (divChannles.querySelector('.selected')??divChannles.firstElementChild).focus();
            window.addEventListener("keyup", handleKeyEvent, true);
        }

        function getStream(channel){
            if(!channel) return;
            divStreams.innerHTML = '';
            divWaitForData.style.display='block';
            divStreams.dataset.count = 0;

            fetch(`https://ytlive.netlify.app/.netlify/functions/livestreams?channel=${channel}`)
            .then(resp => resp.json())
            .then(data => {
                for(const d of data)
                    divStreams.insertAdjacentHTML('beforeend',
                    `<button data-yt="${d[0]}" data-type="S" autofocus>
                        <img src="${d[2].url}"></img>
                        <div style='width:${d[2].width}px'>${d[1]}</div>
                    </button>`);
                divWaitForData.style.display='none';
                divStreams.dataset.count = data.length;
            });
        }
        const handleKeyEvent = (event) => {
            const curBtn = document.activeElement;
            const type = curBtn.dataset.type;
            switch (event.keyCode) {
                case 38: // Up
                    if(type != 'C')
                        (divChannles.querySelector('.selected')??divChannles.firstElementChild).focus();
                    break;
                case 40: // Down
                    if(type=='C' && divStreams.dataset.count > 0)
                        (divStreams.querySelector('.selected')??divStreams.firstElementChild).focus();
                    break;
                case 37: // Left
                    if(curBtn.previousElementSibling)
                        curBtn.previousElementSibling.focus();
                    else
                        curBtn.parentElement.lastElementChild.focus();
                    break;
                case 39: // Right
                    if(curBtn.nextElementSibling)
                        curBtn.nextElementSibling.focus();
                    else
                        curBtn.parentElement.firstElementChild.focus()
                    break;
                case 13: // Enter/Select
                    if(type == 'C'){
                        divChannles.querySelector('.selected')?.classList.remove('selected');
                        getStream(curBtn.dataset.yt);
                    }else{
                        divStreams.querySelector('.selected')?.classList.remove('selected');
                        divSelection.style.display = 'none';
                        window.removeEventListener("keyup", handleKeyEvent, true);
                        document.querySelector('#player').style.display = 'block';
                        player.loadVideoById(curBtn.dataset.yt);
                    }
                    curBtn.classList.add('selected');
                    break;
            }        
        }

        window.addEventListener("keyup", handleKeyEvent, true);
    </script>
</body>
</html>